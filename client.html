<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Meu primeiro jogo</title>
    <style>
        #screen{
            border: 10px solid black;
            width: 400px;
            height: 400px;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
        }
    </style>
</head>
<body>
    <canvas id="screen" width="10px" height="10px"></canvas>

    <script>

        const screen = document.getElementById('screen')
        const context = screen.getContext('2d')


        const game = createGame()
        game.renderGame()

        const keyboardListener = createKeyboardListener()
        keyboardListener.subscribe(game.movePlayer)

        function createKeyboardListener(){
        
            const state = {
                observers: []
            }

            function subscribe(observerFunction) {
                state.observers.push(observerFunction)
            }

            function notifyAll(command) {
                for (const observerFunction of state.observers) {
                    observerFunction(command)
                }
            }

            document.addEventListener('keydown', handleKeydown)

            //obter todos os inputs necessários no jogo
            function handleKeydown(event){
                const keyPressed = event.key
                
                const state = {
                    player: 'player1',
                    keyPressed
                }

                notifyAll(state)

            }

            return {
                subscribe
            }
        }


        function createGame(){ 

            //regras de negócio
            function movePlayer(command) {

                //os atributos recebem os mesmos nomes das funções e retornam a função em vez da sua operação
                const actions = {
                    ArrowUp (player) {
                        if (player.y > 0) {
                            player.y --
                        }
                    },

                    ArrowDown (player) {
                        if (player.y + 1 < screen.height) {
                            player.y ++
                        }
                    },

                    ArrowLeft (player) {
                        if (player.x > 0) {
                            player.x --
                        }
                    },

                    ArrowRight (player) {
                        if (player.x + 1 < screen.width) {
                            player.x ++
                        }
                    }
                }

                const player = game.state.players[command.player]
                const keyPressed = command.keyPressed

                const action = actions[keyPressed]

                if (action){
                    action(player)
                }
                

            }

            //renderizar o jogo para o usuário
            const state = {
                players: {
                    'player1': { x:1, y:1 },
                    'player2': { x:5, y:7 }
                },

                fruits: {
                    'fruit1': { x:3, y:1 }
                }
            }


            function renderGame(){
                context.clearRect(0, 0, 10, 10)

                for (const playerId in state.players) {
                    const player = state.players[playerId]
                    context.fillStyle = 'black'
                    context.fillRect(player.x, player.y, 1, 1)
                }

                for (const fruitId in state.fruits) {
                    const fruit = state.fruits[fruitId]
                    context.fillStyle = 'green'
                    context.fillRect(fruit.x, fruit.y, 1, 1)
                }

                requestAnimationFrame(renderGame)

            }

            return {
                renderGame,
                movePlayer,
                state
            }
        }        
    
        
    </script>

</body>
</html>